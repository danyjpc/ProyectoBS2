<style>
    label {
        color: black;
    }
</style>
<div class="container col-md-8 offset-md-2 mt-2 mb-4">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title" style="color: black;">Nuevo pedido</h3>
            <button class="btn btn-sm" style="color:white; background-color: royalblue;"
                (click)="regresar()">Regresar</button>
        </div>

        <div class="card-body">
            <div class="form-row">

                <div class="form-group col-4">
                    <label for="">Numero de factura</label>
                    <input type="number" class="form-control form-control-sm" [(ngModel)]="kardexActual.num_factura">
                </div>

                <div class="form-group col-4">
                    <label for="">Serie de factura</label>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="kardexActual.serie_factura">
                </div>

                <div class="form-group">
                    <label for="">Fecha de factura</label>
                    <div class="col-4">
                        <form class="form-inline">
                            <div class="form-group">
                                <div class="input-group">
                                    <input class="form-control form-control-sm" placeholder="yyyy-mm-dd" name="d2"
                                        #c2="ngModel" [(ngModel)]="kardexActual.fecha_fac" ngbDatepicker #d2="ngbDatepicker">
                                    <div class="input-group-append">
                                        <button class="btn btn-sm btn-outline-secondary" (click)="d2.toggle()"><i
                                                class="fa fa-calendar-alt fa-2x"></i></button>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- <pre>Model: {{ kardexActual.fecha_fac | json }}</pre>
                            <pre>State: {{ c2.status }}</pre> -->
                    </div>
                </div>

            </div>

            <div class="form-row">
                <div class="form-group col-6">
                    <label for="">Proveedor</label>
                    <input type="text" class="form-control form-control-sm" [(ngModel)]="proveedorSeleccionado" [ngbTypeahead]="searchProv" [resultFormatter]="rFormatterProv" [inputFormatter]="iFormatterProv" (focus)="focusProv$.next($event.target.value)" (click)="clickProv$.next($event.target.value)" #instanceProv="ngbTypeahead">
                </div>

                <div class="form-group col-6">
                    <label for="">Tipo de operacion</label>
                    <select class="custom-select custom-select-sm" [(ngModel)]="kardexActual.tipo_operacion" (change)="prueba()">
                        <option [ngValue]="pedido">Pedido</option>
                        <option [ngValue]="devolucion">Devolucion</option>
                    </select>
                </div>

            </div>

            <br>

            <div class="form-row">
                <!-- <h4 class="col-12">Productos</h4> -->
            </div>

            <div class="card">
                <div class="card-header" style="padding-top: 25px;">
                    <h4 class="card-title text-center">Productos</h4>
                </div>
                <div class="card-body">
                    <div class="form-row">

                        <div class="form-group col-5">
                            <label>Buscar producto...</label>
                            <input *ngIf="productos.length != 0" type="text" class="form-control form-control-sm" [(ngModel)]="productoSeleccionado" [ngbTypeahead]="searchProd" [resultFormatter]="rFormatterProd" [inputFormatter]="iFormatterProd" (focus)="focusProd$.next($event.target.value)" (click)="clickProd$.next($event.target.value)" #instanceProd="ngbTypeahead">
                            <input *ngIf="productos.length == 0" type="text" class="form-control form-control-sm" placeholder="No hay productos disponibles" disabled>
                        </div>

                        <div class="form-group col-2">
                            <label for="">Cantidad</label>
                            <input type="number" class="form-control form-control-sm" [(ngModel)]="cantidad">
                        </div>

                        <div class="form-group col-2">
                            <label for="">Precio unitario</label>
                            <input type="number" class="form-control form-control-sm" [(ngModel)]="precio_unitario">
                        </div>

                        <div class="form-group col-3" style="padding-top: 31px;">
                            <button class="btn btn-sm btn-success" (click)="agregarProducto()">Agregar producto</button>
                        </div>
                    </div>

                    <table class="table table-sm table-hover table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col">No.</th>
                                <th scope="col">Producto</th>
                                <th scope="col">Cantidad</th>
                                <th scope="col">Precio unitario</th>
                                <th scope="col">Subtotal</th>
                                <th scope="col">Opciones</th>
                            </tr>
                        </thead>
                        <tbody *ngIf="detallesKardexList.length != 0">
                            <tr *ngFor="let item of detallesKardexList; index as i">
                                <td>{{i + 1}}</td>
                                <td *ngIf="item.nom_producto != null">{{"[" + item.cod_producto + "] " + item.nom_producto + " - " + item.categoria}}</td>
                                <td *ngIf="item.nom_producto == null">{{buscarProductoParaDetalle(item)}}</td>
                                <td>{{item.cantidad}}</td>
                                <td>{{item.precio_unitario}}</td>
                                <td>{{item.cantidad * item.precio_unitario}}</td>
                                <td>
                                    <button class="btn btn-sm" style="background-color: royalblue; color: white;"
                                        (click)="editarProducto(modalEditar, i, item)">Editar</button>
                                    <button class="btn btn-sm btn-danger"
                                        (click)="eliminarProducto(modalEliminar, i, item)">Eliminar</button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td style="color: black;">TOTAL:</td>
                                <td style="color: black;">{{calcularTotal()}}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>

                    <p *ngIf="detallesKardexList.length == 0">
                        <ngb-alert [dismissible]="false" class="text-center">
                            <h6>No hay registros</h6>
                        </ngb-alert>
                    </p>

                </div>
            </div>

        </div>

        <div class="card-footer">
            <div class="row justify-content-center">
                <button class="btn btn-sm btn-success" (click)="guardar()" style="margin: 5px;">Guardar</button>
                <button class="btn btn-sm btn-danger" (click)="cancelar()" style="margin: 5px;">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<ng-template #modalEliminar let-modal>
    <div class="modal-header" style="background-color: rgb(65, 65, 65);">
        <input type="text" style="display:none;" />
        <div class="row col-12 justify-content-center">
            <h4 class="modal-title" style="color: white;" id="modal-basic-title">Eliminar producto <i class="fas fa-exclamation-triangle" style="color: rgb(255, 196, 0);"></i></h4>
        </div>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span style="color: white;" aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <h5>Se borrara el siguiente registro:</h5>
        <br>
        <div class="row justify-content-center">
            <h4>{{prodEliminar}}</h4>
        </div>
        <div class="row justify-content-center"><h5>Cantidad: {{cantEliminar}}</h5></div>
        <div class="row justify-content-center"><h5>Precio unitario: {{precioEliminar}}</h5></div>
        <div class="row justify-content-center"><h5>Total: {{precioEliminar * cantEliminar}}</h5></div>
        <hr>
        <div class="row justify-content-center">
            <h5>Â¿Esta seguro?</h5>
        </div>
    </div>

    <div class="modal-footer" style="background-color: rgb(65, 65, 65);">
        <button type="button" class="btn btn-danger btn-sm" (click)="modal.close('Aceptar')">Aceptar</button>
        <button type="button" class="btn btn-warning btn-sm" (click)="modal.dismiss('Cancelar')">Cancelar</button>
    </div>
</ng-template>

<ng-template #modalEditar let-modal>
    <div class="modal-header" style="background-color: rgb(65, 65, 65);">

        <h4 class="modal-title" style="color: white;" id="modal-basic-title">Editar producto</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span style="color: white;" aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="modal-body">
        <div class="form-row">
            <input type="text" style="display: none;">
            <div class="form-group col-5">
                <label>Buscar producto...</label>
                <input *ngIf="productos.length != 0" type="text" class="form-control form-control-sm"
                    [(ngModel)]="productoSeleccionadoEditar" [ngbTypeahead]="searchProdEditar"
                    [resultFormatter]="rFormatterProdEditar" [inputFormatter]="iFormatterProdEditar"
                    (focus)="focusProdEditar$.next($event.target.value)"
                    (click)="clickProdEditar$.next($event.target.value)" #instanceProdEditar="ngbTypeahead">
                <input *ngIf="productos.length == 0" type="text" class="form-control form-control-sm"
                    placeholder="No hay productos disponibles" disabled>
            </div>

            <div class="form-group col-2">
                <label for="">Cantidad</label>
                <input type="number" class="form-control form-control-sm" [(ngModel)]="productoEditar.cantidad">
            </div>

            <div class="form-group col-2">
                <label for="">Precio unitario</label>
                <input type="number" class="form-control form-control-sm" [(ngModel)]="productoEditar.precio_unitario">
            </div>
        </div>

    </div>

    <div class="modal-footer" style="background-color: rgb(65, 65, 65);">
        <button type="button" class="btn btn-success btn-sm" (click)="modal.close('Guardar')">Guardar</button>
        <button type="button" class="btn btn-warning btn-sm" (click)="modal.dismiss('Cancelar')">Cancelar</button>
    </div>
</ng-template>